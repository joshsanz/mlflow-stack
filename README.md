# MLflow Stack

A complete MLflow tracking server stack with PostgreSQL and MinIO, designed for Raspberry Pi deployments and local development.

## 🏗️ Architecture

The stack consists of three main components:

- **PostgreSQL 15**: Database backend for MLflow experiment metadata and metrics
- **MinIO**: S3-compatible object storage for MLflow artifacts (models, plots, files)
- **MLflow Server**: Web-based experiment tracking server with REST API

## 🚀 Quick Start

### Option 1: Docker Compose (Recommended for Local Development)

```bash
cd docker
docker-compose up -d
```

Access services at:
- **MLflow UI**: http://localhost:32000
- **MinIO Console**: http://localhost:30091

### Option 2: Kubernetes with Helm

```bash
# Deploy to Kubernetes
helm install mlflow-stack . -n mlflow --create-namespace

# Get generated MinIO credentials
./get-secrets.sh
```

## 📁 Repository Structure

```
mlflow-stack/
├── Chart.yaml              # Helm chart metadata
├── values.yaml             # Helm chart configuration
├── templates/              # Kubernetes manifests
│   ├── secrets.yaml        # Auto-generated credentials
│   ├── pv-pvc.yaml         # Persistent storage
│   ├── postgresql-*.yaml   # PostgreSQL deployment & service
│   ├── minio-*.yaml        # MinIO deployment & service
│   ├── mlflow-*.yaml       # MLflow deployment & service
│   └── init-job.yaml       # MinIO bucket initialization
├── docker/                 # Docker Compose setup
│   ├── docker-compose.yml  # Complete stack definition
│   ├── scripts/            # Initialization scripts
│   └── README.md           # Docker-specific documentation
├── get-secrets.sh          # Retrieve Kubernetes secrets
└── uninstall.sh            # Clean removal script
```

## ⚙️ Configuration

### Helm Chart (values.yaml)

```yaml
postgresql:
  user: mlflow
  password: mlflowpass
  database: mlflowdb
  storage: 5Gi
  path: /data/postgresql

minio:
  # Auto-generated credentials (recommended)
  generateCredentials: true
  bucket: mlflow
  storage: 50Gi
  path: /data/minio
  nodePortApi: 30090
  nodePortConsole: 30091

mlflow:
  storage: 5Gi
  path: /data/mlflow
  nodePort: 32000
```

### Docker Compose Environment

Copy `.env` file and customize:

```bash
cd docker
cp .env .env.local
# Edit .env.local with your values
```

## 🔒 Security

### Default Credentials

⚠️ **Change these in production!**

**Kubernetes (Auto-generated)**:
- MinIO credentials are automatically generated on first install
- Use `./get-secrets.sh` to retrieve them

**Docker Compose**:
- MinIO: `minioadmin` / `minioadmin123`
- PostgreSQL: `mlflow` / `mlflowpass`

### Credential Management

**Kubernetes**: Credentials are stored as Kubernetes secrets and auto-generated by default.

**Docker**: Override defaults using environment variables in `.env.local`:
```bash
AWS_ACCESS_KEY_ID=your_access_key
AWS_SECRET_ACCESS_KEY=your_secret_key
POSTGRES_USER=your_db_user
POSTGRES_PASSWORD=your_db_password
```

## 💾 Data Persistence

### Kubernetes
- Uses PersistentVolumes with local storage
- Data persisted to `/data/{service}` on the host
- Storage sizes configurable via `values.yaml`

### Docker Compose
- Uses Docker volumes for data persistence
- Automatic volume management
- Data survives container restarts

## 🛠️ Management

### Kubernetes Commands

```bash
# Deploy
helm install mlflow-stack . -n mlflow --create-namespace

# Upgrade
helm upgrade mlflow-stack . -n mlflow

# Uninstall (keeps data)
helm uninstall mlflow-stack -n mlflow

# Complete removal (including data)
./uninstall.sh
```

### Docker Commands

```bash
# Start stack
docker-compose up -d

# View logs
docker-compose logs -f [service_name]

# Stop stack (keeps data)
docker-compose down

# Remove everything including data
docker-compose down -v
```

## 🌐 Port Configuration

Both deployment methods use consistent port mapping:

| Service | Port | Description |
|---------|------|-------------|
| MLflow Server | 32000 | Web UI and API |
| MinIO API | 30090 | S3-compatible API |
| MinIO Console | 30091 | Web management UI |
| PostgreSQL | 5432 | Database (internal) |

## 🔧 Using MLflow

### Python Client Setup

```python
import mlflow
import os

# Configure MLflow client
mlflow.set_tracking_uri("http://localhost:32000")

# For artifact storage (if accessing MinIO directly)
os.environ["MLFLOW_S3_ENDPOINT_URL"] = "http://localhost:30090"
os.environ["AWS_ACCESS_KEY_ID"] = "minioadmin"  # Use your actual credentials
os.environ["AWS_SECRET_ACCESS_KEY"] = "minioadmin123"

# Start logging
with mlflow.start_run():
    mlflow.log_param("alpha", 0.1)
    mlflow.log_metric("rmse", 0.786)
    mlflow.sklearn.log_model(model, "model")
```

### CLI Usage

```bash
# Set tracking server
export MLFLOW_TRACKING_URI=http://localhost:32000

# Run experiment
mlflow run . -P alpha=0.1
```

## 🐛 Troubleshooting

### Common Issues

**MinIO bucket creation fails**:
```bash
# Docker
docker-compose logs minio-init

# Kubernetes
kubectl logs job/mlflow-init -n mlflow
```

**MLflow can't connect to PostgreSQL**:
- Check PostgreSQL health
- Verify credentials in secrets/environment
- Ensure services are on same network

**Permission denied on volumes**:
```bash
# Docker
sudo chown -R $(id -u):$(id -g) /var/lib/docker/volumes/docker_*

# Kubernetes
sudo chown -R 1001:1001 /data/postgresql
```

### Health Checks

**Docker**:
```bash
docker-compose ps  # Check service status
```

**Kubernetes**:
```bash
kubectl get pods -n mlflow
kubectl describe pod <pod-name> -n mlflow
```

## 📊 Resource Requirements

### Minimum Requirements
- **CPU**: 2 cores
- **Memory**: 4GB RAM
- **Storage**: 20GB available space
- **Network**: HTTP/HTTPS access on configured ports

### Recommended for Production
- **CPU**: 4+ cores
- **Memory**: 8GB+ RAM
- **Storage**: 100GB+ SSD
- **High availability**: Consider running multiple replicas

## 🤝 Contributing

1. Fork the repository
2. Create a feature branch
3. Make your changes
4. Test with both Kubernetes and Docker deployments
5. Submit a pull request

## 📄 License

MIT License - see [LICENSE](LICENSE) file for details.

## 🔗 Links

- [MLflow Documentation](https://mlflow.org/docs/latest/index.html)
- [MinIO Documentation](https://docs.min.io/)
- [PostgreSQL Documentation](https://www.postgresql.org/docs/)